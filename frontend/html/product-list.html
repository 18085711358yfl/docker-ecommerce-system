<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“åˆ—è¡¨ - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F7F3E7;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }
        
        h1 {
            color: #333;
            font-size: 24px;
        }
        
        .back-btn {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: #1976D2;
        }
        
        .toolbar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border: 1px solid #e0e0e0;
        }
        
        .toolbar select,
        .toolbar input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .toolbar button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .toolbar button:hover {
            background: #45a049;
        }
        
        table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        
        thead {
            background: #2196F3;
            color: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        .action-btn {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .view-btn {
            background: #2196F3;
            color: white;
        }
        
        .edit-btn {
            background: #FFC107;
            color: white;
        }
        
        .delete-btn {
            background: #f44336;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        .price {
            color: #f44336;
            font-weight: bold;
        }
        
        .stock {
            color: #4CAF50;
        }
        
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            background: #f5f5f5;
            color: #666;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid #ddd;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .modal-content {
            background-color: white;
            margin: 20px auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            position: sticky;
            bottom: -30px;
            background: white;
            margin-left: -30px;
            margin-right: -30px;
            margin-bottom: -30px;
            padding: 20px 30px;
        }
        
        .btn-save {
            padding: 10px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-save:hover {
            background: #45a049;
        }
        
        .btn-save:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-cancel {
            padding: 10px 30px;
            background: #999;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-cancel:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å•†å“åˆ—è¡¨ç®¡ç†</h1>
            <a href="index.html" class="back-btn">è¿”å›é¦–é¡µ</a>
        </header>
        
        <div class="toolbar">
            <select id="categoryFilter" onchange="filterByCategory()">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
            </select>
            <input type="text" id="searchInput" placeholder="æœç´¢å•†å“åç§°...">
            <button onclick="searchProducts()">æœç´¢</button>
            <button onclick="loadProducts()">åˆ·æ–°</button>
            <button onclick="openAddModal()" style="background: #4CAF50;">æ–°å¢å•†å“</button>
        </div>
        
        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        
        <table id="productTable" style="display: none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>å›¾ç‰‡</th>
                    <th>å•†å“åç§°</th>
                    <th>æè¿°</th>
                    <th>ä»·æ ¼</th>
                    <th>åº“å­˜</th>
                    <th>åˆ†ç±»</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>
    
    <!-- ç¼–è¾‘/æ–°å¢æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ç¼–è¾‘å•†å“</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>å•†å“å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="file" id="imageFile" accept="image/*" onchange="previewImage(this)">
                    <input type="hidden" id="editImageUrl">
                    <div id="imagePreview" style="margin-top: 10px;"></div>
                    <small style="color: #666; display: block; margin-top: 5px;">é€‰æ‹©å›¾ç‰‡åï¼Œç‚¹å‡»ä¿å­˜æŒ‰é’®å°†è‡ªåŠ¨ä¸Šä¼ </small>
                </div>
                <div class="form-group">
                    <label>å•†å“åç§°</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>å•†å“æè¿°</label>
                    <textarea id="editDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>ä»·æ ¼</label>
                    <input type="number" id="editPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>åº“å­˜</label>
                    <input type="number" id="editStock" required>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <input type="text" id="editCategory">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-save">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = '/api';
        let allProducts = [];
        
        window.onload = function() {
            loadProducts();
        };
        
        async function loadProducts() {
            const loading = document.getElementById('loading');
            const table = document.getElementById('productTable');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    allProducts = result.data;
                    displayProducts(allProducts);
                    populateCategories(allProducts);
                }
            } catch (err) {
                alert('åŠ è½½å¤±è´¥: ' + err.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function displayProducts(products) {
            const tbody = document.getElementById('tableBody');
            const table = document.getElementById('productTable');
            
            tbody.innerHTML = '';
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>';
            } else {
                products.forEach(product => {
                    const row = document.createElement('tr');
                    const imageHtml = product.imageUrl 
                        ? `<img src="${product.imageUrl}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">`
                        : '<div style="width: 50px; height: 50px; background: #f5f5f5; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #ccc;">æ— å›¾</div>';
                    
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${imageHtml}</td>
                        <td><strong>${product.name}</strong></td>
                        <td>${(product.description || '').substring(0, 50)}...</td>
                        <td class="price">Â¥${product.price}</td>
                        <td class="stock">${product.stock}</td>
                        <td>${product.category ? `<span class="category-badge">${product.category}</span>` : '-'}</td>
                        <td>
                            <button class="action-btn view-btn" onclick="viewProduct(${product.id})">æŸ¥çœ‹</button>
                            <button class="action-btn edit-btn" onclick="editProduct(${product.id})">ç¼–è¾‘</button>
                            <button class="action-btn delete-btn" onclick="deleteProduct(${product.id})">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            table.style.display = 'table';
        }
        
        function populateCategories(products) {
            const select = document.getElementById('categoryFilter');
            const categories = [...new Set(products.map(p => p.category).filter(c => c))];
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }
        
        function filterByCategory() {
            const category = document.getElementById('categoryFilter').value;
            
            if (!category) {
                displayProducts(allProducts);
            } else {
                const filtered = allProducts.filter(p => p.category === category);
                displayProducts(filtered);
            }
        }
        
        async function searchProducts() {
            const keyword = document.getElementById('searchInput').value.trim();
            
            if (!keyword) {
                displayProducts(allProducts);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/products/search?keyword=${encodeURIComponent(keyword)}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    displayProducts(result.data);
                }
            } catch (err) {
                alert('æœç´¢å¤±è´¥: ' + err.message);
            }
        }
        
        function viewProduct(id) {
            window.location.href = `product-detail.html?id=${id}`;
        }
        
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢å•†å“';
            document.getElementById('editForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('editImageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageFile').value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            document.getElementById('editModal').style.display = 'block';
        }
        
        async function editProduct(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${id}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const product = result.data;
                    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å•†å“';
                    document.getElementById('editId').value = product.id;
                    document.getElementById('editName').value = product.name;
                    document.getElementById('editDescription').value = product.description || '';
                    document.getElementById('editPrice').value = product.price;
                    document.getElementById('editStock').value = product.stock;
                    document.getElementById('editCategory').value = product.category || '';
                    document.getElementById('editImageUrl').value = product.imageUrl || '';
                    
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    document.getElementById('imageFile').value = '';
                    
                    // æ˜¾ç¤ºå½“å‰å›¾ç‰‡
                    if (product.imageUrl) {
                        document.getElementById('imagePreview').innerHTML = 
                            `<img src="${product.imageUrl}" style="max-width: 200px; max-height: 200px; border-radius: 5px;" onerror="this.style.display='none'; this.parentElement.innerHTML+='<p style=color:red>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
                    } else {
                        document.getElementById('imagePreview').innerHTML = '';
                    }
                    
                    document.getElementById('editModal').style.display = 'block';
                }
            } catch (err) {
                alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥: ' + err.message);
            }
        }
        
        // é¢„è§ˆé€‰æ‹©çš„å›¾ç‰‡
        function previewImage(input) {
            const file = input.files[0];
            const previewDiv = document.getElementById('imagePreview');
            
            if (file) {
                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    input.value = '';
                    previewDiv.innerHTML = '';
                    return;
                }
                
                // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    input.value = '';
                    previewDiv.innerHTML = '';
                    return;
                }
                
                // æ˜¾ç¤ºæœ¬åœ°é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewDiv.innerHTML = `
                        <div style="padding: 10px; background: #fff3e0; border-radius: 5px; margin-top: 10px;">
                            <p style="color: #e65100; margin-bottom: 10px;">ğŸ“· å·²é€‰æ‹©å›¾ç‰‡ï¼ˆç‚¹å‡»ä¿å­˜åå°†è‡ªåŠ¨ä¸Šä¼ ï¼‰</p>
                            <img src="${e.target.result}" 
                                 style="max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ddd;">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.innerHTML = '';
            }
        }
        
        // ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
        async function uploadImageToServer() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                return null; // æ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œè¿”å›null
            }
            
            console.log('å¼€å§‹ä¸Šä¼ å›¾ç‰‡:', file.name, file.size, file.type);
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_BASE_URL}/upload/image`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('ä¸Šä¼ å“åº”çŠ¶æ€:', response.status);
                const result = await response.json();
                console.log('ä¸Šä¼ å“åº”æ•°æ®:', result);
                
                if (result.success) {
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', result.url);
                    return result.url;
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (err) {
                console.error('ä¸Šä¼ å¼‚å¸¸:', err);
                throw err;
            }
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            
            try {
                // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
                submitButton.disabled = true;
                submitButton.textContent = 'å¤„ç†ä¸­...';
                
                const id = document.getElementById('editId').value;
                const fileInput = document.getElementById('imageFile');
                let imageUrl = document.getElementById('editImageUrl').value;
                
                console.log('=== è¡¨å•æäº¤è°ƒè¯•ä¿¡æ¯ ===');
                console.log('å•†å“ID:', id || 'æ–°å»ºå•†å“');
                console.log('æ˜¯å¦é€‰æ‹©äº†æ–°å›¾ç‰‡:', fileInput.files.length > 0);
                console.log('å½“å‰å›¾ç‰‡URL:', imageUrl);
                
                // å¦‚æœé€‰æ‹©äº†æ–°å›¾ç‰‡ï¼Œå…ˆä¸Šä¼ 
                if (fileInput.files.length > 0) {
                    submitButton.textContent = 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';
                    try {
                        const uploadedUrl = await uploadImageToServer();
                        if (uploadedUrl) {
                            imageUrl = uploadedUrl;
                            console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œæ–°URL:', imageUrl);
                            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                            fileInput.value = '';
                        }
                    } catch (uploadErr) {
                        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + uploadErr.message + '\n\næ˜¯å¦ç»§ç»­ä¿å­˜å•†å“ä¿¡æ¯ï¼ˆä¸å«å›¾ç‰‡ï¼‰ï¼Ÿ');
                        const continueWithoutImage = confirm('ç‚¹å‡»"ç¡®å®š"ç»§ç»­ä¿å­˜ï¼Œç‚¹å‡»"å–æ¶ˆ"è¿”å›ä¿®æ”¹');
                        if (!continueWithoutImage) {
                            return;
                        }
                    }
                }
                
                submitButton.textContent = 'æ­£åœ¨ä¿å­˜...';
                
                const productData = {
                    name: document.getElementById('editName').value,
                    description: document.getElementById('editDescription').value,
                    price: parseFloat(document.getElementById('editPrice').value),
                    stock: parseInt(document.getElementById('editStock').value),
                    category: document.getElementById('editCategory').value,
                    imageUrl: imageUrl || null
                };
                
                console.log('æäº¤çš„å•†å“æ•°æ®:', productData);
                
                let response;
                if (id) {
                    // æ›´æ–°å•†å“
                    response = await fetch(`${API_BASE_URL}/products/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(productData)
                    });
                } else {
                    // æ–°å¢å•†å“
                    response = await fetch(`${API_BASE_URL}/products`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(productData)
                    });
                }
                
                const result = await response.json();
                console.log('æœåŠ¡å™¨å“åº”:', result);
                
                if (result.success) {
                    alert(id ? 'å•†å“æ›´æ–°æˆåŠŸï¼' : 'å•†å“æ–°å¢æˆåŠŸï¼');
                    closeEditModal();
                    loadProducts();
                } else {
                    alert((id ? 'æ›´æ–°' : 'æ–°å¢') + 'å¤±è´¥: ' + result.message);
                }
            } catch (err) {
                console.error('ä¿å­˜å¤±è´¥:', err);
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            } finally {
                // æ¢å¤æäº¤æŒ‰é’®
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });
        
        async function deleteProduct(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/products/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadProducts();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥: ' + err.message);
            }
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
