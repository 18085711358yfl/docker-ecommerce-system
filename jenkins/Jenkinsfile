pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
        IMAGE_TAG = "${BUILD_NUMBER}"
        BACKEND_IMAGE = "ecommerce-backend:${IMAGE_TAG}"
        FRONTEND_IMAGE = "ecommerce-frontend:${IMAGE_TAG}"
    }
    
    stages {
        stage('代码检出') {
            steps {
                echo '正在检出代码...'
                checkout scm
            }
        }
        
        stage('后端单元测试') {
            steps {
                echo '运行后端单元测试...'
                dir('backend') {
                    sh 'mvn clean test'
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('后端代码质量检查') {
            steps {
                echo '执行代码质量检查...'
                dir('backend') {
                    sh 'mvn checkstyle:check || true'
                }
            }
        }
        
        stage('构建后端镜像') {
            steps {
                echo '构建后端Docker镜像...'
                dir('backend') {
                    script {
                        docker.build(BACKEND_IMAGE)
                    }
                }
            }
        }
        
        stage('构建前端镜像') {
            steps {
                echo '构建前端Docker镜像...'
                dir('frontend') {
                    script {
                        docker.build(FRONTEND_IMAGE)
                    }
                }
            }
        }
        
        stage('镜像安全扫描') {
            steps {
                echo '执行镜像安全扫描...'
                script {
                    // 使用Trivy进行镜像扫描，启用缓存和优化设置
                    sh """
                        # 创建Trivy缓存目录
                        mkdir -p /tmp/trivy-cache || true
                        
                        # 使用Trivy扫描，启用缓存和优化选项
                        docker run --rm \
                            -v /var/run/docker.sock:/var/run/docker.sock \
                            -v /tmp/trivy-cache:/root/.cache/trivy \
                            aquasec/trivy:latest image \
                            --cache-dir /root/.cache/trivy \
                            --severity CRITICAL \
                            --timeout 10m \
                            --no-progress \
                            --skip-db-update \
                            ${BACKEND_IMAGE} || true
                    """
                }
            }
        }
        
        stage('集成测试') {
            steps {
                echo '运行集成测试...'
                sh '''
                    # 停止可能存在的旧容器
                    docker-compose down || true
                    # 启动服务
                    docker-compose up -d
                    # 等待服务启动
                    echo "等待服务启动..."
                    sleep 30
                    # 检查容器状态
                    docker-compose ps
                    # 检查后端健康状态 - 使用 docker exec 在容器内检查
                    echo "检查后端健康状态..."
                    if docker exec ecommerce-backend curl -sf http://localhost:8080/actuator/health; then
                        echo "后端健康检查通过"
                    elif docker run --rm --network docker_ecommerce-network curlimages/curl:latest curl -sf http://ecommerce-backend:8080/actuator/health; then
                        echo "后端健康检查通过（通过临时容器）"
                    else
                        echo "后端健康检查失败，查看日志："
                        docker-compose logs backend | tail -50
                        exit 1
                    fi
                    # 清理
                    docker-compose down
                '''
            }
        }
        
        stage('推送镜像到仓库') {
            when {
                branch 'main'
            }
            steps {
                echo '推送镜像到Docker仓库...'
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", DOCKER_CREDENTIALS_ID) {
                        docker.image(BACKEND_IMAGE).push()
                        docker.image(BACKEND_IMAGE).push('latest')
                        docker.image(FRONTEND_IMAGE).push()
                        docker.image(FRONTEND_IMAGE).push('latest')
                    }
                }
            }
        }
        
        stage('部署到测试环境') {
            when {
                branch 'develop'
            }
            steps {
                echo '部署到测试环境...'
                sh '''
                    docker-compose down || true
                    docker-compose up -d
                '''
            }
        }
        
        stage('部署到生产环境') {
            when {
                branch 'main'
            }
            steps {
                echo '部署到生产环境...'
                input message: '确认部署到生产环境？', ok: '部署'
                script {
                    // 检查是否存在 docker-compose.prod.yml，如果存在则使用，否则使用默认配置
                    sh '''
                        if [ -f docker-compose.prod.yml ]; then
                            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down || true
                            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
                        else
                            docker-compose down || true
                            docker-compose up -d
                        fi
                    '''
                }
            }
        }
        
        stage('健康检查') {
            steps {
                echo '执行健康检查...'
                sh '''
                    sleep 30
                    curl -f http://localhost:80/health || exit 1
                    curl -f http://localhost:8080/actuator/health || exit 1
                '''
            }
        }
    }
    
    post {
        always {
            echo '清理工作空间...'
            cleanWs()
        }
        success {
            echo '构建成功！'
            // 发送成功通知
        }
        failure {
            echo '构建失败！'
            // 发送失败通知
        }
    }
}
