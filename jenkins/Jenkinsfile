pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
        IMAGE_TAG = "${BUILD_NUMBER}"
        BACKEND_IMAGE = "ecommerce-backend:${IMAGE_TAG}"
        FRONTEND_IMAGE = "ecommerce-frontend:${IMAGE_TAG}"
    }
    
    stages {
        stage('代码检出') {
            steps {
                echo '正在检出代码...'
                checkout scm
            }
        }
        
        stage('后端单元测试') {
            steps {
                echo '运行后端单元测试...'
                dir('backend') {
                    sh 'mvn clean test'
                }
            }
            post {
                always {
                    script {
                        def testReportPath = 'backend/target/surefire-reports/*.xml'
                        echo "测试报告路径: ${testReportPath}"
                        // 检查报告文件是否存在
                        sh "ls -la backend/target/surefire-reports/ || echo '报告目录不存在'"
                        junit testReportPath
                    }
                }
            }
        }
        
        stage('后端代码质量检查') {
            steps {
                echo '执行代码质量检查...'
                dir('backend') {
                    sh 'mvn checkstyle:check || true'
                }
            }
        }
        
        stage('构建后端镜像') {
            steps {
                echo '构建后端Docker镜像...'
                dir('backend') {
                    script {
                        docker.build(BACKEND_IMAGE)
                    }
                }
            }
        }
        
        stage('构建前端镜像') {
            steps {
                echo '构建前端Docker镜像...'
                dir('frontend') {
                    script {
                        docker.build(FRONTEND_IMAGE)
                    }
                }
            }
        }
        
        stage('镜像安全扫描') {
            steps {
                echo '执行镜像安全扫描...'
                script {
                    // 使用Trivy进行镜像扫描，启用缓存和优化设置
                    sh """
                        # 创建Trivy缓存目录
                        mkdir -p /tmp/trivy-cache || true
                        
                        # 检查是否存在数据库缓存
                        if [ -f /tmp/trivy-cache/db/trivy.db ]; then
                            echo "使用已有的数据库缓存"
                            SKIP_DB_UPDATE="--skip-db-update"
                        else
                            echo "首次运行，下载漏洞数据库"
                            SKIP_DB_UPDATE=""
                        fi
                        
                        # 使用Trivy扫描，启用缓存和优化选项
                        docker run --rm \
                            -v /var/run/docker.sock:/var/run/docker.sock \
                            -v /tmp/trivy-cache:/root/.cache/trivy \
                            aquasec/trivy:latest image \
                            --cache-dir /root/.cache/trivy \
                            --severity CRITICAL \
                            --timeout 10m \
                            --no-progress \
                            \${SKIP_DB_UPDATE} \
                            ${BACKEND_IMAGE} || true
                    """
                }
            }
        }
        
        stage('集成测试') {
            steps {
                echo '运行集成测试...'
                sh '''
                    # 停止可能存在的旧容器
                    docker-compose down || true
                    # 启动服务
                    docker-compose up -d
                    # 等待服务启动
                    echo "等待服务启动..."
                    sleep 30
                    # 检查容器状态
                    docker-compose ps
                    # 检查后端健康状态 - 使用 docker exec 在容器内检查
                    echo "检查后端健康状态..."
                    if docker exec ecommerce-backend curl -sf http://localhost:8080/actuator/health; then
                        echo "后端健康检查通过"
                    elif docker run --rm --network docker_ecommerce-network curlimages/curl:latest curl -sf http://ecommerce-backend:8080/actuator/health; then
                        echo "后端健康检查通过（通过临时容器）"
                    else
                        echo "后端健康检查失败，查看日志："
                        docker-compose logs backend | tail -50
                        exit 1
                    fi
                    # 注意：不在这里清理，让健康检查阶段使用
                '''
            }
        }
        
        stage('推送镜像到仓库') {
            when {
                expression {
                    def branchName = env.BRANCH_NAME ?: env.GIT_BRANCH?.replaceAll('origin/', '') ?: ''
                    echo "检测到的分支: ${branchName}"
                    return branchName == 'main' || branchName == 'master' || branchName == 'refs/heads/main' || branchName == 'refs/heads/master'
                }
            }
            steps {
                echo '推送镜像到Docker仓库...'
                script {
                    echo "当前分支: ${env.BRANCH_NAME ?: 'N/A'}"
                    echo "Git分支: ${env.GIT_BRANCH ?: 'N/A'}"
                    docker.withRegistry("https://${DOCKER_REGISTRY}", DOCKER_CREDENTIALS_ID) {
                        docker.image(BACKEND_IMAGE).push()
                        docker.image(BACKEND_IMAGE).push('latest')
                        docker.image(FRONTEND_IMAGE).push()
                        docker.image(FRONTEND_IMAGE).push('latest')
                    }
                }
            }
        }
        
        stage('部署到测试环境') {
            when {
                branch 'develop'
            }
            steps {
                echo '部署到测试环境...'
                sh '''
                    docker-compose down || true
                    docker-compose up -d
                '''
            }
        }
        
        stage('部署到生产环境') {
            when {
                branch 'main'
            }
            steps {
                echo '部署到生产环境...'
                input message: '确认部署到生产环境？', ok: '部署'
                script {
                    // 检查是否存在 docker-compose.prod.yml，如果存在则使用，否则使用默认配置
                    sh '''
                        if [ -f docker-compose.prod.yml ]; then
                            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down || true
                            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
                        else
                            docker-compose down || true
                            docker-compose up -d
                        fi
                    '''
                }
            }
        }
        
        stage('健康检查') {
            steps {
                echo '执行健康检查...'
                sh '''
                    # 检查服务是否在运行，如果没有则启动
                    if ! docker-compose ps 2>/dev/null | grep -q "Up"; then
                        echo "服务未运行，启动服务..."
                        docker-compose up -d
                        echo "等待服务启动..."
                        sleep 30
                    else
                        echo "服务已在运行"
                    fi
                    
                    # 检查容器状态
                    docker-compose ps
                    
                    # 检查前端健康状态
                    echo "检查前端健康状态..."
                    if docker exec ecommerce-frontend curl -sf http://localhost:80/health 2>/dev/null; then
                        echo "前端健康检查通过"
                    elif docker run --rm --network docker_ecommerce-network curlimages/curl:latest curl -sf http://ecommerce-frontend:80/health 2>/dev/null; then
                        echo "前端健康检查通过（通过临时容器）"
                    else
                        echo "前端健康检查失败，查看日志："
                        docker-compose logs frontend | tail -20
                        exit 1
                    fi
                    
                    # 检查后端健康状态
                    echo "检查后端健康状态..."
                    if docker exec ecommerce-backend curl -sf http://localhost:8080/actuator/health 2>/dev/null; then
                        echo "后端健康检查通过"
                    elif docker run --rm --network docker_ecommerce-network curlimages/curl:latest curl -sf http://ecommerce-backend:8080/actuator/health 2>/dev/null; then
                        echo "后端健康检查通过（通过临时容器）"
                    else
                        echo "后端健康检查失败，查看日志："
                        docker-compose logs backend | tail -20
                        exit 1
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            echo '清理工作空间...'
            cleanWs()
        }
        success {
            echo '构建成功！'
            // 发送成功通知
        }
        failure {
            echo '构建失败！'
            // 发送失败通知
        }
    }
}
