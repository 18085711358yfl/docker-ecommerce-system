pipeline {
    agent any
    
    // é…ç½®ä»£ç æäº¤è§¦å‘æœºåˆ¶
    triggers {
        // GitHub/GitLab Webhook è§¦å‘å™¨
        githubPush()
        // æˆ–è€…ä½¿ç”¨é€šç”¨çš„ SCM è½®è¯¢ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        pollSCM('H/5 * * * *')  // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»£ç å˜æ›´
    }
    
    environment {
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_USERNAME = 'flyang03'
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
        IMAGE_TAG = "${BUILD_NUMBER}"
        BACKEND_IMAGE = "${DOCKER_USERNAME}/ecommerce-backend:${IMAGE_TAG}"
        FRONTEND_IMAGE = "${DOCKER_USERNAME}/ecommerce-frontend:${IMAGE_TAG}"
    }
    
    stages {
        stage('ä»£ç æ£€å‡º') {
            steps {
                echo 'æ­£åœ¨æ£€å‡ºä»£ç ...'
                checkout scm
            }
        }
        
        stage('åç«¯å•å…ƒæµ‹è¯•') {
            steps {
                echo 'è¿è¡Œåç«¯å•å…ƒæµ‹è¯•...'
                dir('backend') {
                    sh 'mvn clean test'
                }
            }
            post {
                always {
                    script {
                        echo 'æ”¶é›†æµ‹è¯•æŠ¥å‘Š...'
                        // JUnit æµ‹è¯•æŠ¥å‘Š
                        junit allowEmptyResults: true, testResults: 'backend/target/surefire-reports/*.xml'
                        
                        // å‘å¸ƒ HTML æµ‹è¯•æŠ¥å‘Š
                        publishHTML([
                            allowMissing: true,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: 'backend/target/surefire-reports',
                            reportFiles: '*.html',
                            reportName: 'å•å…ƒæµ‹è¯•æŠ¥å‘Š',
                            reportTitles: 'å•å…ƒæµ‹è¯•ç»“æœ'
                        ])
                    }
                }
                success {
                    echo 'âœ… å•å…ƒæµ‹è¯•é€šè¿‡'
                }
                failure {
                    echo 'âŒ å•å…ƒæµ‹è¯•å¤±è´¥'
                }
            }
        }
        
        stage('åç«¯ä»£ç è´¨é‡æ£€æŸ¥') {
            steps {
                echo 'æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥...'
                dir('backend') {
                    sh 'mvn checkstyle:check || true'
                }
            }
        }
        
        stage('æ„å»ºåç«¯é•œåƒ') {
            steps {
                echo 'æ„å»ºåç«¯Dockeré•œåƒ...'
                dir('backend') {
                    script {
                        // å…ˆæ„å»ºæœ¬åœ°é•œåƒ
                        def localImage = docker.build("ecommerce-backend:${IMAGE_TAG}")
                        // ä½¿ç”¨ docker tag å‘½ä»¤æ‰“æ ‡ç­¾ä¸ºæ¨é€æ ¼å¼
                        sh """
                            docker tag ecommerce-backend:${IMAGE_TAG} ${DOCKER_USERNAME}/ecommerce-backend:${IMAGE_TAG}
                            docker tag ecommerce-backend:${IMAGE_TAG} ${DOCKER_USERNAME}/ecommerce-backend:latest
                        """
                    }
                }
            }
        }
        
        stage('æ„å»ºå‰ç«¯é•œåƒ') {
            steps {
                echo 'æ„å»ºå‰ç«¯Dockeré•œåƒ...'
                dir('frontend') {
                    script {
                        // å…ˆæ„å»ºæœ¬åœ°é•œåƒ
                        def localImage = docker.build("ecommerce-frontend:${IMAGE_TAG}")
                        // ä½¿ç”¨ docker tag å‘½ä»¤æ‰“æ ‡ç­¾ä¸ºæ¨é€æ ¼å¼
                        sh """
                            docker tag ecommerce-frontend:${IMAGE_TAG} ${DOCKER_USERNAME}/ecommerce-frontend:${IMAGE_TAG}
                            docker tag ecommerce-frontend:${IMAGE_TAG} ${DOCKER_USERNAME}/ecommerce-frontend:latest
                        """
                    }
                }
            }
        }
        
        stage('é•œåƒå®‰å…¨æ‰«æ') {
            steps {
                echo 'æ‰§è¡Œé•œåƒå®‰å…¨æ‰«æ...'
                script {
                    // ä½¿ç”¨Trivyè¿›è¡Œé•œåƒæ‰«æï¼Œå¯ç”¨ç¼“å­˜å’Œä¼˜åŒ–è®¾ç½®
                    sh """
                        # æ¸…ç† Docker æœªä½¿ç”¨çš„èµ„æºä»¥é‡Šæ”¾ç©ºé—´
                        docker system prune -f || true
                        
                        # ä½¿ç”¨ Jenkins å·¥ä½œç©ºé—´å­˜å‚¨ç¼“å­˜ï¼ˆæŒä¹…åŒ–ï¼‰
                        TRIVY_CACHE_DIR=\${WORKSPACE}/.trivy-cache
                        mkdir -p \${TRIVY_CACHE_DIR} || true
                        
                        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ•°æ®åº“ç¼“å­˜
                        if [ -f \${TRIVY_CACHE_DIR}/db/trivy.db ]; then
                            echo "ä½¿ç”¨å·²æœ‰çš„æ•°æ®åº“ç¼“å­˜"
                            SKIP_DB_UPDATE="--skip-db-update"
                        else
                            echo "é¦–æ¬¡è¿è¡Œï¼Œä¸‹è½½æ¼æ´æ•°æ®åº“"
                            SKIP_DB_UPDATE=""
                        fi
                        
                        # ä½¿ç”¨Trivyæ‰«æï¼Œå¯ç”¨ç¼“å­˜å’Œä¼˜åŒ–é€‰é¡¹
                        docker run --rm \
                            -v /var/run/docker.sock:/var/run/docker.sock \
                            -v \${TRIVY_CACHE_DIR}:/root/.cache/trivy \
                            aquasec/trivy:latest image \
                            --cache-dir /root/.cache/trivy \
                            --severity CRITICAL \
                            --timeout 10m \
                            --no-progress \
                            \${SKIP_DB_UPDATE} \
                            ecommerce-backend:${IMAGE_TAG} || true
                    """
                }
            }
        }
        
        stage('é›†æˆæµ‹è¯•') {
            steps {
                echo 'è¿è¡Œé›†æˆæµ‹è¯•...'
                sh '''
                    # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§å®¹å™¨
                    docker-compose down || true
                    # å¯åŠ¨æœåŠ¡
                    docker-compose up -d
                    # ç­‰å¾…æœåŠ¡å¯åŠ¨
                    echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                    sleep 30
                    # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                    docker-compose ps
                    # æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€ - ä½¿ç”¨ docker exec åœ¨å®¹å™¨å†…æ£€æŸ¥
                    echo "æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€..."
                    if docker exec ecommerce-backend curl -sf http://localhost:8080/actuator/health; then
                        echo "åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
                    elif docker run --rm --network docker_ecommerce-network curlimages/curl:latest curl -sf http://ecommerce-backend:8080/actuator/health; then
                        echo "åç«¯å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆé€šè¿‡ä¸´æ—¶å®¹å™¨ï¼‰"
                    else
                        echo "åç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                        docker-compose logs backend | tail -50
                        exit 1
                    fi
                    # æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œæ¸…ç†ï¼Œè®©å¥åº·æ£€æŸ¥é˜¶æ®µä½¿ç”¨
                '''
            }
        }
        
        stage('æ¨é€é•œåƒåˆ°ä»“åº“') {
            when {
                expression {
                    def branchName = env.BRANCH_NAME ?: env.GIT_BRANCH?.replaceAll('origin/', '') ?: ''
                    echo "æ£€æµ‹åˆ°çš„åˆ†æ”¯: ${branchName}"
                    return branchName == 'main' || branchName == 'master' || branchName == 'refs/heads/main' || branchName == 'refs/heads/master'
                }
            }
            steps {
                echo 'æ¨é€é•œåƒåˆ°Dockerä»“åº“...'
                script {
                    echo "å½“å‰åˆ†æ”¯: ${env.BRANCH_NAME ?: 'N/A'}"
                    echo "Gitåˆ†æ”¯: ${env.GIT_BRANCH ?: 'N/A'}"
                    echo "Docker Hubç”¨æˆ·å: ${DOCKER_USERNAME}"
                    echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"
                    
                    // ä½¿ç”¨ Jenkins Credentials æ­£ç¡®ç™»å½• Docker Hub
                    withCredentials([usernamePassword(
                        credentialsId: DOCKER_CREDENTIALS_ID,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo "æ­£åœ¨ç™»å½• Docker Hub..."
                            echo "\$DOCKER_PASS" | docker login -u "\$DOCKER_USER" --password-stdin
                            echo "Docker Hub ç™»å½•æˆåŠŸï¼"
                            
                            echo "æ¨é€åç«¯é•œåƒ: ${DOCKER_USERNAME}/ecommerce-backend:${IMAGE_TAG}"
                            docker push ${DOCKER_USERNAME}/ecommerce-backend:${IMAGE_TAG}
                            docker push ${DOCKER_USERNAME}/ecommerce-backend:latest
                            
                            echo "æ¨é€å‰ç«¯é•œåƒ: ${DOCKER_USERNAME}/ecommerce-frontend:${IMAGE_TAG}"
                            docker push ${DOCKER_USERNAME}/ecommerce-frontend:${IMAGE_TAG}
                            docker push ${DOCKER_USERNAME}/ecommerce-frontend:latest
                            
                            echo "æ‰€æœ‰é•œåƒæ¨é€å®Œæˆï¼"
                        """
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ') {
            when {
                branch 'develop'
            }
            steps {
                echo 'éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ...'
                sh '''
                    docker-compose down || true
                    docker-compose up -d
                '''
            }
        }
        
        stage('éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ') {
            when {
                branch 'main'
            }
            steps {
                echo 'éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ...'
                input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ', ok: 'éƒ¨ç½²'
                script {
                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ docker-compose.prod.ymlï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
                    sh '''
                        if [ -f docker-compose.prod.yml ]; then
                            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down || true
                            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
                        else
                            docker-compose down || true
                            docker-compose up -d
                        fi
                    '''
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                echo 'æ‰§è¡Œå¥åº·æ£€æŸ¥...'
                sh '''
                    # æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰åˆ™å¯åŠ¨
                    if ! docker-compose ps 2>/dev/null | grep -q "Up"; then
                        echo "æœåŠ¡æœªè¿è¡Œï¼Œå¯åŠ¨æœåŠ¡..."
                        docker-compose up -d
                        echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                        sleep 30
                    else
                        echo "æœåŠ¡å·²åœ¨è¿è¡Œ"
                    fi
                    
                    # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                    docker-compose ps
                    
                    # æ£€æŸ¥å‰ç«¯å¥åº·çŠ¶æ€
                    echo "æ£€æŸ¥å‰ç«¯å¥åº·çŠ¶æ€..."
                    if docker exec ecommerce-frontend curl -sf http://localhost:80/health 2>/dev/null; then
                        echo "å‰ç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
                    elif docker run --rm --network docker_ecommerce-network curlimages/curl:latest curl -sf http://ecommerce-frontend:80/health 2>/dev/null; then
                        echo "å‰ç«¯å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆé€šè¿‡ä¸´æ—¶å®¹å™¨ï¼‰"
                    else
                        echo "å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                        docker-compose logs frontend | tail -20
                        exit 1
                    fi
                    
                    # æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
                    echo "æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€..."
                    if docker exec ecommerce-backend curl -sf http://localhost:8080/actuator/health 2>/dev/null; then
                        echo "åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
                    elif docker run --rm --network docker_ecommerce-network curlimages/curl:latest curl -sf http://ecommerce-backend:8080/actuator/health 2>/dev/null; then
                        echo "åç«¯å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆé€šè¿‡ä¸´æ—¶å®¹å™¨ï¼‰"
                    else
                        echo "åç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                        docker-compose logs backend | tail -20
                        exit 1
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            echo 'æ¸…ç†å·¥ä½œç©ºé—´...'
            
            // ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
            script {
                echo 'ğŸ“Š ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š...'
                
                // æ”¶é›†æ‰€æœ‰æµ‹è¯•ç»“æœ
                junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml, **/target/failsafe-reports/*.xml'
                
                // å‘å¸ƒæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šï¼ˆå¦‚æœæœ‰ï¼‰
                publishHTML([
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'backend/target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'ä»£ç è¦†ç›–ç‡æŠ¥å‘Š',
                    reportTitles: 'JaCoCo Coverage Report'
                ])
                
                // å‘å¸ƒæ„å»ºè¶‹åŠ¿æŠ¥å‘Š
                echo 'æ„å»ºç¼–å·: ${BUILD_NUMBER}'
                echo 'æ„å»ºçŠ¶æ€: ${currentBuild.result}'
                echo 'æ„å»ºæ—¶é•¿: ${currentBuild.durationString}'
            }
            
            cleanWs()
        }
        success {
            echo 'âœ… æ„å»ºæˆåŠŸï¼'
            emailext(
                subject: "âœ… Jenkinsæ„å»ºæˆåŠŸ - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>æ„å»ºæˆåŠŸ</h2>
                    <p><strong>é¡¹ç›®:</strong> ${env.JOB_NAME}</p>
                    <p><strong>æ„å»ºç¼–å·:</strong> ${env.BUILD_NUMBER}</p>
                    <p><strong>æ„å»ºæ—¶é—´:</strong> ${new Date()}</p>
                    <p><strong>Gitåˆ†æ”¯:</strong> ${env.GIT_BRANCH}</p>
                    <p><strong>Gitæäº¤:</strong> ${env.GIT_COMMIT}</p>
                    <p><a href="${env.BUILD_URL}">æŸ¥çœ‹æ„å»ºè¯¦æƒ…</a></p>
                    <p><a href="${env.BUILD_URL}testReport/">æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š</a></p>
                """,
                to: '${DEFAULT_RECIPIENTS}',
                mimeType: 'text/html'
            )
        }
        failure {
            echo 'âŒ æ„å»ºå¤±è´¥ï¼'
            emailext(
                subject: "âŒ Jenkinsæ„å»ºå¤±è´¥ - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>æ„å»ºå¤±è´¥</h2>
                    <p><strong>é¡¹ç›®:</strong> ${env.JOB_NAME}</p>
                    <p><strong>æ„å»ºç¼–å·:</strong> ${env.BUILD_NUMBER}</p>
                    <p><strong>æ„å»ºæ—¶é—´:</strong> ${new Date()}</p>
                    <p><strong>Gitåˆ†æ”¯:</strong> ${env.GIT_BRANCH}</p>
                    <p><strong>Gitæäº¤:</strong> ${env.GIT_COMMIT}</p>
                    <p><strong>å¤±è´¥åŸå› :</strong> ${currentBuild.result}</p>
                    <p><a href="${env.BUILD_URL}">æŸ¥çœ‹æ„å»ºè¯¦æƒ…</a></p>
                    <p><a href="${env.BUILD_URL}console">æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º</a></p>
                    <p><a href="${env.BUILD_URL}testReport/">æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š</a></p>
                """,
                to: '${DEFAULT_RECIPIENTS}',
                mimeType: 'text/html'
            )
        }
    }
}
